# 数据库关系图

## 实体关系概览

```
┌─────────────────────────────────────────────────────────────────┐
│                           用户系统                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                     │
│  │    Users     │         │   Passkeys   │                     │
│  │──────────────│         │──────────────│                     │
│  │ id (PK)      │◄────────│ user_id (FK) │                     │
│  │ username     │   1:N   │ pubkey_blob  │                     │
│  │ email        │         │ created_at   │                     │
│  │ avatar       │         └──────────────┘                     │
│  │ level        │                                              │
│  │ role         │         ┌──────────────┐                     │
│  └──────┬───────┘         │   Credits    │                     │
│         │                 │──────────────│                     │
│         │◄────────────────│ user_id (PK) │                     │
│         │     1:1         │ balance      │                     │
│         │                 │ total_earned │                     │
│         │                 └──────────────┘                     │
│         │                                                      │
│         │                 ┌──────────────┐                     │
│         │                 │ UserGroups   │                     │
│         │                 │──────────────│                     │
│         │◄────────────────│ level (PK)   │                     │
│         │     N:1         │ name         │                     │
│         │                 │ permissions  │                     │
│         │                 └──────────────┘                     │
│         │                                                      │
└─────────┼──────────────────────────────────────────────────────┘
          │
          │ 发帖/回复
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                           论坛内容                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                     │
│  │    Nodes     │         │   Threads    │                     │
│  │──────────────│         │──────────────│                     │
│  │ id (PK)      │◄────────│ node_id (FK) │                     │
│  │ name         │   1:N   │ author_id    │────────────────┐    │
│  │ description  │         │ title        │                │    │
│  │ parent_id    │◄────┐   │ body         │                │    │
│  └──────────────┘     │   │ created_at   │                │    │
│         ▲             │   │ view_count   │                │    │
│         │             │   │ reply_count  │                │    │
│         │    自关联   │   │ is_pinned    │                │    │
│         └─────────────┘   └──────┬───────┘                │    │
│                                  │                        │    │
│                                  │ 1:N                    │    │
│                                  ▼                        │    │
│                           ┌──────────────┐               │    │
│                           │   Replies    │               │    │
│                           │──────────────│               │    │
│                           │ id (PK)      │               │    │
│                           │ thread_id    │               │    │
│                           │ author_id    │───────────────┘    │
│                           │ body         │     N:1            │
│                           │ created_at   │                    │
│                           │ reply_to_id  │◄────────────────┐  │
│                           └──────────────┘   自关联(嵌套)   │  │
│                                                           │  │
│                           ┌──────────────┐                │  │
│                           │  Comments    │                │  │
│                           │──────────────│                │  │
│                           │ id (PK)      │                │  │
│                           │ parent_type  │                │  │
│                           │ parent_id    │◄───────────────┘  │
│                           │ author_id    │───────────────────┘
│                           │ body         │     N:1
│                           └──────────────┘
│
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                           投票系统                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                     │
│  │   Threads    │         │ PollOptions  │                     │
│  │──────────────│         │──────────────│                     │
│  │ id (PK)      │◄────────│ thread_id    │                     │
│  │ type='poll'  │   1:N   │ option_text  │                     │
│  └──────────────┘         │ vote_count   │                     │
│                           └──────┬───────┘                     │
│                                  │                             │
│                                  │ 1:N                          │
│                                  ▼                             │
│                           ┌──────────────┐                     │
│                           │  UserVotes   │                     │
│                           │──────────────│                     │
│                           │ user_id (PK) │◄────────────────┐   │
│                           │ option_id    │                 │   │
│                           │ voted_at     │                 │   │
│                           └──────────────┘                 │   │
│                                                            │   │
└────────────────────────────────────────────────────────────┼───┘
                                                             │
                                                             │ N:1
                                                             ▼
                                                      ┌──────────────┐
                                                      │    Users     │
                                                      └──────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                           私信系统                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐     ┌──────────────────┐                 │
│  │  Conversations   │     │ PrivateMessages  │                 │
│  │──────────────────│     │──────────────────│                 │
│  │ id (PK)          │◄────│ conversation_id  │                 │
│  │ user1_id (FK)    │ 1:N │ author_id (FK)   │                 │
│  │ user2_id (FK)    │     │ body (S3 key)    │                 │
│  │ last_message_at  │     │ created_at       │                 │
│  │ unread_count_1   │     └──────────────────┘                 │
│  │ unread_count_2   │                                          │
│  └──────────────────┘                                          │
│         │  │                                                   │
│         │  └────────────────┐                                  │
│         │                   │                                  │
│         ▼                   ▼                                  │
│  ┌──────────────┐    ┌──────────────┐                         │
│  │    Users     │    │    Users     │                         │
│  └──────────────┘    └──────────────┘                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                           其他表                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                     │
│  │  Reminders   │         │   Settings   │                     │
│  │──────────────│         │──────────────│                     │
│  │ id (PK)      │         │ key (PK)     │                     │
│  │ user_id (FK) │◄────────│ value        │                     │
│  │ type         │   N:1   │ updated_at   │                     │
│  │ title        │         └──────────────┘                     │
│  │ is_read      │                                              │
│  └──────────────┘                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 关系说明

### 一对多 (1:N)
- **Users : Threads** - 一个用户可以发多个帖子
- **Users : Replies** - 一个用户可以发多个回复
- **Nodes : Threads** - 一个版块可以有多个帖子
- **Threads : Replies** - 一个帖子可以有多个回复
- **Threads : PollOptions** - 一个投票帖子可以有多个选项

### 一对一 (1:1)
- **Users : Credits** - 一个用户对应一个积分记录

### 多对多 (N:M)
- **Users : PollOptions** - 通过 UserVotes 表实现，一个用户可以投多个选项，一个选项可以被多个用户投

### 自关联
- **Nodes : Nodes** - 版块的父版块（层级结构）
- **Replies : Replies** - 回复的嵌套（回复给某个回复）

## 关键字段说明

### 通用字段
- `id` - 主键，Users 使用 TEXT(UUID)，其他使用 INTEGER AUTOINCREMENT
- `created_at` - Unix 时间戳（秒）
- `*_id` - 外键关联

### 特殊字段
- `body` - 在 Threads/Replies/Comments 中存储 HTML 内容
- `body` - 在 PrivateMessages 中存储 S3 key
- `type` - 区分不同类型的内容（discussion/poll/raffle）
- `is_author_only` - 标记仅作者可见的内容

## 索引策略

### 主键索引（自动创建）
所有表的主键自动创建索引

### 外键索引（手动创建）
```sql
-- 加速关联查询
CREATE INDEX idx_threads_node ON Threads(node_id);
CREATE INDEX idx_replies_thread ON Replies(thread_id);
CREATE INDEX idx_conversations_user ON Conversations(user1_id, user2_id);
```

### 常用查询索引
```sql
-- 加速排序和筛选
CREATE INDEX idx_threads_last_reply ON Threads(last_reply_at);
CREATE INDEX idx_reminders_unread ON Reminders(user_id, is_read);
```

## 数据流示例

### 发帖流程
```
1. Users → 验证用户身份
2. Nodes → 验证版块存在
3. Threads → 插入帖子数据
4. Nodes → 更新版块帖子计数
5. Credits → 给用户增加积分（可选）
6. Reminders → 通知关注者（可选）
```

### 私信流程
```
1. Users → 验证双方用户
2. Conversations → 查找或创建会话
3. S3 → 存储消息内容（生成 key）
4. PrivateMessages → 存储 S3 key
5. Conversations → 更新未读数和最后消息
```

## 注意事项

1. **外键约束** - 删除用户会级联删除关联数据
2. **软删除** - 部分表使用 is_deleted 或 role='deleted' 标记删除
3. **时间戳** - 统一使用 Unix 时间戳（秒）存储
4. **JSON 字段** - permissions 等字段使用 JSON 字符串存储
