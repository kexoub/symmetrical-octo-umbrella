# 部署指南

## S3 对象存储配置

本项目使用 S3 兼容的对象存储服务来存储文件（头像、图片、附件、Logo等）。

### 支持的 S3 服务

- **AWS S3**
- **腾讯云 COS**
- **阿里云 OSS**
- **MinIO**
- **Cloudflare R2** (S3 兼容模式)
- **其他 S3 兼容服务**

### 配置步骤

1. **复制环境变量示例文件**
   ```bash
   cp .env.example .env
   ```

2. **编辑 .env 文件，填入 S3 配置信息**
   ```bash
   S3_ENDPOINT=https://your-s3-endpoint.com
   S3_BUCKET=your-bucket-name
   S3_ACCESS_KEY_ID=your-access-key-id
   S3_SECRET_ACCESS_KEY=your-secret-access-key
   S3_PUBLIC_URL=https://cdn.yourdomain.com
   ```

3. **配置 wrangler.jsonc**
   
   编辑 `wrangler.jsonc` 文件，更新 `vars` 部分的 `S3_PUBLIC_URL`：
   ```json
   "vars": {
     "RP_NAME": "Community Board",
     "RP_SUBTITLE": "An opensource-friendly forum",
     "REGISTER_ENABLED": true,
     "S3_PUBLIC_URL": "https://your-cdn-domain.com"
   }
   ```

4. **设置 Secrets（敏感信息）**
   
   使用 wrangler 设置 S3 的敏感配置信息：
   ```bash
   wrangler secret put S3_ENDPOINT
   wrangler secret put S3_BUCKET
   wrangler secret put S3_ACCESS_KEY_ID
   wrangler secret put S3_SECRET_ACCESS_KEY
   ```

### 常用 S3 服务配置示例

#### AWS S3
```bash
S3_ENDPOINT=https://s3.ap-northeast-1.amazonaws.com
S3_BUCKET=my-forum-bucket
S3_REGION=ap-northeast-1
S3_PUBLIC_URL=https://my-forum-bucket.s3.ap-northeast-1.amazonaws.com
```

#### 腾讯云 COS
```bash
S3_ENDPOINT=https://cos.ap-guangzhou.myqcloud.com
S3_BUCKET=my-forum-bucket-1250000000
S3_REGION=ap-guangzhou
S3_PUBLIC_URL=https://my-forum-bucket-1250000000.cos.ap-guangzhou.myqcloud.com
```

#### Cloudflare R2
```bash
S3_ENDPOINT=https://<account-id>.r2.cloudflarestorage.com
S3_BUCKET=my-forum-bucket
S3_REGION=auto
S3_PUBLIC_URL=https://pub-<hash>.r2.dev
```

## 线上部署

[![Deploy with Cloudflare Workers](https://deploy.workers.cloudflare.com/button)](https://deploy.workers.cloudflare.com/?url=https%3A%2F%2Fgithub.com%2Fserverless-bbs%2Fserverless-bbs)

## 本地调试

安装 Wrangler: 如果您还没有安装 Wrangler (Cloudflare 的命令行工具)，请在您的终端中运行以下命令进行全局安装：

```bash
# 克隆代码
git clone https://github.com/serverless-bbs/serverless-bbs.git
cd serverless-bbs

# 全局安装 wrangler
sudo npm install -g wrangler

# 安装依赖
yarn

# 配置 S3 环境变量
cp .env.example .env
# 编辑 .env 文件填入 S3 配置

# 初始化D1数据库
yarn db:migrate

# 启动
yarn dev
```

## 数据库迁移

当更新代码后，可能需要运行数据库迁移：

```bash
# 本地开发环境
yarn db:migrate

# 线上环境
yarn db:migrations:apply
```
